<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Cesium-DrawCommand | SuperMan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="&amp;ensp; &amp;ensp; &amp;ensp; 在Cesium当中不管影像&#x2F;地形&#x2F;倾斜摄影如何调度，还是在地球之上任何绘制几何体，最终都会组装成一个DrawCommand渲染指令；然后将DrawCommand送入Context中执行渲染任务。 1. DrawCommand中有什么？12345678910111213141516171819202122232425262728293031323334353">
<meta property="og:type" content="article">
<meta property="og:title" content="Cesium-DrawCommand">
<meta property="og:url" content="https://github.com/SuperManZTF/ThreeDimensional/2020/11/08/4-Cesium-DrawCommand/index.html">
<meta property="og:site_name" content="SuperMan">
<meta property="og:description" content="&amp;ensp; &amp;ensp; &amp;ensp; 在Cesium当中不管影像&#x2F;地形&#x2F;倾斜摄影如何调度，还是在地球之上任何绘制几何体，最终都会组装成一个DrawCommand渲染指令；然后将DrawCommand送入Context中执行渲染任务。 1. DrawCommand中有什么？12345678910111213141516171819202122232425262728293031323334353">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-11-08T04:52:34.000Z">
<meta property="article:modified_time" content="2021-08-25T06:09:28.711Z">
<meta property="article:author" content="SuperManZTF">
<meta property="article:tag" content="Cesium 3D GIS">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/ThreeDimensional/atom.xml" title="SuperMan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/ThreeDimensional/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/ThreeDimensional/" id="logo">SuperMan</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/ThreeDimensional/">Home</a>
        
          <a class="main-nav-link" href="/ThreeDimensional/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/ThreeDimensional/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/SuperManZTF/ThreeDimensional"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-4-Cesium-DrawCommand" class="article article-type-post" itemscope
   itemprop="blogPost">
   <div class="article-meta">
      <a href="/ThreeDimensional/2020/11/08/4-Cesium-DrawCommand/" class="article-date">
  <time datetime="2020-11-08T04:52:34.000Z" itemprop="datePublished">2020-11-08</time>
</a>
      
   </div>
   <div class="article-inner">
      
      
      <header class="article-header">
         
  
    <h1 class="article-title" itemprop="name">
      Cesium-DrawCommand
    </h1>
  

      </header>
      
      <!-- <div class="article-entry" itemprop="articleBody">
         
         <p>&ensp; &ensp; &ensp; 在Cesium当中不管影像/地形/倾斜摄影如何调度，还是在地球之上任何绘制几何体，最终都会组装成一个DrawCommand渲染指令；然后将DrawCommand送入Context中执行渲染任务。</p>
<h2 id="1-DrawCommand中有什么？"><a href="#1-DrawCommand中有什么？" class="headerlink" title="1. DrawCommand中有什么？"></a>1. DrawCommand中有什么？</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> DrawCommand(options) &#123;</span><br><span class="line">  this._boundingVolume = options.boundingVolume;// 包围球</span><br><span class="line">  this._orientedBoundingBox = options.orientedBoundingBox;// 旋转包围盒</span><br><span class="line">  this._cull = defaultValue(options.cull, <span class="literal">true</span>);// 是否进行视锥剔除，这涉及到View.js里面的指令过滤</span><br><span class="line">  this._occlude = defaultValue(options.occlude, <span class="literal">true</span>);// 是否进行地球遮蔽判断，这涉及到View.js里面的指令过滤</span><br><span class="line">  this._modelMatrix = options.modelMatrix;// 模型矩阵，对，就是MVP的M</span><br><span class="line">  this._primitiveType = defaultValue(// WebGL渲染几何体的类型 点 线 面...</span><br><span class="line">    options.primitiveType,</span><br><span class="line">    PrimitiveType.TRIANGLES</span><br><span class="line">  );</span><br><span class="line">  this._vertexArray = options.vertexArray;// 顶点属性数据 VAO</span><br><span class="line">  this._count = options.count;// 顶点数量</span><br><span class="line">  this._offset = defaultValue(options.offset, 0);// 顶点偏移</span><br><span class="line">  this._instanceCount = defaultValue(options.instanceCount, 0);// 实例化渲染数量</span><br><span class="line">  this._shaderProgram = options.shaderProgram;// 着色程序</span><br><span class="line">  this._uniformMap = options.uniformMap;// 纹理贴图</span><br><span class="line">  this._renderState = options.renderState;// 渲染状态：深度/模板/颜色缓冲操作设置（例如 禁止模板测试 禁止颜色写入等）</span><br><span class="line">  this._framebuffer = options.framebuffer;// 当前DrawCommand渲染所用的FBO</span><br><span class="line">  this._pass = options.pass;// 当前DrawCommand所属的Pass，Pass用来控制先后渲染顺序</span><br><span class="line">  this._executeInClosestFrustum = defaultValue(</span><br><span class="line">    options.executeInClosestFrustum,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  );</span><br><span class="line">  this._owner = options.owner;// 所对应的逻辑对象,例如某个地块的DrawCommand属于QuadtreeTile实例</span><br><span class="line">  this._debugShowBoundingVolume = defaultValue(// 是否调试包围体，会打开这个DrawCommand包围体</span><br><span class="line">    options.debugShowBoundingVolume,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  );</span><br><span class="line">  this._debugOverlappingFrustums = 0;</span><br><span class="line">  this._castShadows = defaultValue(options.castShadows, <span class="literal">false</span>);// 产生阴影</span><br><span class="line">  this._receiveShadows = defaultValue(options.receiveShadows, <span class="literal">false</span>);// 接受阴影</span><br><span class="line">  this._pickId = options.pickId;// 拾取ID，这里涉及到Cesium中的GPUPicker拾取机制</span><br><span class="line">  this._pickOnly = defaultValue(options.pickOnly, <span class="literal">false</span>);// 是否只用于拾取，这里涉及到Cesium中的GPUPicker拾取机制</span><br><span class="line"></span><br><span class="line">  this.dirty = <span class="literal">true</span>;</span><br><span class="line">  this.lastDirtyTime = 0;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @private</span><br><span class="line">   */</span><br><span class="line">  this.derivedCommands = &#123;&#125;;// 衍生指令，这里涉及到HDR/对数深度/阴影的处理，在原来指令的基础上衍生其他功能，例如增加shader代码块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&ensp; &ensp; &ensp; 由上面的代码以及注释可以看出，DrawCommand中包含了渲染一个对象所需的各种信息，顶点属性/FBO/Depth||Color||Stencil/纹理/Shader等。将这个类的实例执行excute方法即可使用Context对其进行渲染，Context封装了WebGL上下文，是直接面向GL的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Executes the draw <span class="built_in">command</span>.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;Context&#125; context The renderer context <span class="keyword">in</span> <span class="built_in">which</span> to draw.</span><br><span class="line"> * @param &#123;PassState&#125; [passState] The state <span class="keyword">for</span> the current render pass.</span><br><span class="line"> */</span><br><span class="line">DrawCommand.prototype.execute = <span class="keyword">function</span> (context, passState) &#123;</span><br><span class="line">  context.draw(this, passState);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>&ensp; &ensp; &ensp; 上面代码中尤其值得注意的是passState这个参数，这个对象很重要！！！在DrawCommand中有一个_framebuffer变量，当这个变量不为Undefined时，说明这个渲染指令将绘制到挂载的这个FBO中，否则将绘制到passState中的FBO上。</p>
<blockquote><p>文章中有任何错误，请批评勘正</p>
<footer><strong>@superman 1780721345@qq.com</strong></footer></blockquote>

         
      </div> -->
      <div class="article-entry" itemprop="articleBody">
         
         
         
         <p>&ensp; &ensp; &ensp; 在Cesium当中不管影像/地形/倾斜摄影如何调度，还是在地球之上任何绘制几何体，最终都会组装成一个DrawCommand渲染指令；然后将DrawCommand送入Context中执行渲染任务。</p>
<h2 id="1-DrawCommand中有什么？"><a href="#1-DrawCommand中有什么？" class="headerlink" title="1. DrawCommand中有什么？"></a>1. DrawCommand中有什么？</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> DrawCommand(options) &#123;</span><br><span class="line">  this._boundingVolume = options.boundingVolume;// 包围球</span><br><span class="line">  this._orientedBoundingBox = options.orientedBoundingBox;// 旋转包围盒</span><br><span class="line">  this._cull = defaultValue(options.cull, <span class="literal">true</span>);// 是否进行视锥剔除，这涉及到View.js里面的指令过滤</span><br><span class="line">  this._occlude = defaultValue(options.occlude, <span class="literal">true</span>);// 是否进行地球遮蔽判断，这涉及到View.js里面的指令过滤</span><br><span class="line">  this._modelMatrix = options.modelMatrix;// 模型矩阵，对，就是MVP的M</span><br><span class="line">  this._primitiveType = defaultValue(// WebGL渲染几何体的类型 点 线 面...</span><br><span class="line">    options.primitiveType,</span><br><span class="line">    PrimitiveType.TRIANGLES</span><br><span class="line">  );</span><br><span class="line">  this._vertexArray = options.vertexArray;// 顶点属性数据 VAO</span><br><span class="line">  this._count = options.count;// 顶点数量</span><br><span class="line">  this._offset = defaultValue(options.offset, 0);// 顶点偏移</span><br><span class="line">  this._instanceCount = defaultValue(options.instanceCount, 0);// 实例化渲染数量</span><br><span class="line">  this._shaderProgram = options.shaderProgram;// 着色程序</span><br><span class="line">  this._uniformMap = options.uniformMap;// 纹理贴图</span><br><span class="line">  this._renderState = options.renderState;// 渲染状态：深度/模板/颜色缓冲操作设置（例如 禁止模板测试 禁止颜色写入等）</span><br><span class="line">  this._framebuffer = options.framebuffer;// 当前DrawCommand渲染所用的FBO</span><br><span class="line">  this._pass = options.pass;// 当前DrawCommand所属的Pass，Pass用来控制先后渲染顺序</span><br><span class="line">  this._executeInClosestFrustum = defaultValue(</span><br><span class="line">    options.executeInClosestFrustum,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  );</span><br><span class="line">  this._owner = options.owner;// 所对应的逻辑对象,例如某个地块的DrawCommand属于QuadtreeTile实例</span><br><span class="line">  this._debugShowBoundingVolume = defaultValue(// 是否调试包围体，会打开这个DrawCommand包围体</span><br><span class="line">    options.debugShowBoundingVolume,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  );</span><br><span class="line">  this._debugOverlappingFrustums = 0;</span><br><span class="line">  this._castShadows = defaultValue(options.castShadows, <span class="literal">false</span>);// 产生阴影</span><br><span class="line">  this._receiveShadows = defaultValue(options.receiveShadows, <span class="literal">false</span>);// 接受阴影</span><br><span class="line">  this._pickId = options.pickId;// 拾取ID，这里涉及到Cesium中的GPUPicker拾取机制</span><br><span class="line">  this._pickOnly = defaultValue(options.pickOnly, <span class="literal">false</span>);// 是否只用于拾取，这里涉及到Cesium中的GPUPicker拾取机制</span><br><span class="line"></span><br><span class="line">  this.dirty = <span class="literal">true</span>;</span><br><span class="line">  this.lastDirtyTime = 0;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @private</span><br><span class="line">   */</span><br><span class="line">  this.derivedCommands = &#123;&#125;;// 衍生指令，这里涉及到HDR/对数深度/阴影的处理，在原来指令的基础上衍生其他功能，例如增加shader代码块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&ensp; &ensp; &ensp; 由上面的代码以及注释可以看出，DrawCommand中包含了渲染一个对象所需的各种信息，顶点属性/FBO/Depth||Color||Stencil/纹理/Shader等。将这个类的实例执行excute方法即可使用Context对其进行渲染，Context封装了WebGL上下文，是直接面向GL的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Executes the draw <span class="built_in">command</span>.</span><br><span class="line"> *</span><br><span class="line"> * @param &#123;Context&#125; context The renderer context <span class="keyword">in</span> <span class="built_in">which</span> to draw.</span><br><span class="line"> * @param &#123;PassState&#125; [passState] The state <span class="keyword">for</span> the current render pass.</span><br><span class="line"> */</span><br><span class="line">DrawCommand.prototype.execute = <span class="keyword">function</span> (context, passState) &#123;</span><br><span class="line">  context.draw(this, passState);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>&ensp; &ensp; &ensp; 上面代码中尤其值得注意的是passState这个参数，这个对象很重要！！！在DrawCommand中有一个_framebuffer变量，当这个变量不为Undefined时，说明这个渲染指令将绘制到挂载的这个FBO中，否则将绘制到passState中的FBO上。</p>
<blockquote><p>文章中有任何错误，请批评勘正</p>
<footer><strong>@superman 1780721345@qq.com</strong></footer></blockquote>

         
         
      </div>
      <footer class="article-footer">
         <a data-url="https://github.com/SuperManZTF/ThreeDimensional/2020/11/08/4-Cesium-DrawCommand/" data-id="cl5bvnge90002joqtheku4m2k" class="article-share-link">Share</a>
         
         
      </footer>
   </div>
   
   
<nav id="article-nav">
  
    <a href="/ThreeDimensional/2021/01/04/5-Cesium-%E5%9C%B0%E7%90%83%E7%93%A6%E7%89%87%E9%81%AE%E6%8C%A1%E8%AE%A1%E7%AE%97/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Cesium-地球瓦片遮挡计算
        
      </div>
    </a>
  
  
    <a href="/ThreeDimensional/2020/11/08/3-Cesium-Pass/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Cesium-Pass 渲染对象类型</div>
    </a>
  
</nav>

   
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/ThreeDimensional/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/ThreeDimensional/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/ThreeDimensional/archives/2020/11/">November 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/ThreeDimensional/2021/08/25/1-Cesium-ZFighting/">Cesium-Z-Fighting 深度冲突问题</a>
          </li>
        
          <li>
            <a href="/ThreeDimensional/2021/01/04/5-Cesium-%E5%9C%B0%E7%90%83%E7%93%A6%E7%89%87%E9%81%AE%E6%8C%A1%E8%AE%A1%E7%AE%97/">Cesium-地球瓦片遮挡计算</a>
          </li>
        
          <li>
            <a href="/ThreeDimensional/2020/11/08/4-Cesium-DrawCommand/">Cesium-DrawCommand</a>
          </li>
        
          <li>
            <a href="/ThreeDimensional/2020/11/08/3-Cesium-Pass/">Cesium-Pass 渲染对象类型</a>
          </li>
        
          <li>
            <a href="/ThreeDimensional/2020/11/08/2-Cesium-Precision/">Cesium-Precision 精度问题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 SuperManZTF<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/ThreeDimensional/" class="mobile-nav-link">Home</a>
  
    <a href="/ThreeDimensional/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/ThreeDimensional/fancybox/jquery.fancybox.css">

  
<script src="/ThreeDimensional/fancybox/jquery.fancybox.pack.js"></script>




<script src="/ThreeDimensional/js/script.js"></script>




  </div>
</body>
</html>